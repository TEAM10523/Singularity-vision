# AprilTag 坐标显示功能使用指南

## 概览

Singularity-vision 现在支持完整的 AprilTag 坐标转换和显示功能，包括：
- 实时 AprilTag 检测
- 多坐标系姿态估计
- 可视化坐标显示
- 视频流标注

## 功能特性

### 🎯 实时检测与坐标转换
- **单标签姿态估计**：计算每个标签的相机、机器人和场地坐标
- **多标签姿态估计**：使用多个标签提高定位精度
- **实时坐标转换**：基于 WPILib 几何库的坐标系转换
- **误差估计**：提供估计误差和置信度信息

### 🖥️ 前端界面显示

#### 1. 控制面板统计
- **Robot X/Y**：在顶部统计面板显示机器人当前位置
- **AprilTags**：显示检测到的标签数量
- **实时更新**：每秒更新一次坐标数据

#### 2. 机器人姿态区域
- **多标签姿态**：显示融合多个标签的高精度机器人位置
- **坐标网格**：X、Y、Z 位置和 Yaw 角度
- **误差信息**：显示估计误差值

#### 3. 标签详情区域
- **单标签姿态**：显示每个标签计算的机器人位置
- **相对位置**：标签相对于机器人的位置
- **距离角度**：计算标签距离和相对角度

#### 4. 视频流标注
- **绿色轮廓**：标注检测到的 AprilTag
- **ID 显示**：显示标签 ID 号
- **坐标信息**：在标签附近显示机器人位置
- **多标签汇总**：顶部显示多标签估计结果

## 配置说明

### 1. 基本配置 (config.json)
```json
{
  "apriltag": {
    "enabled": true,
    "tag_size": 0.165,
    "camera_matrix": [
      [905.32671946, 0, 679.6204086],
      [0, 906.14946047, 331.96782248],
      [0, 0, 1]
    ],
    "distortion_coeffs": [0.02907126, -0.03349167, 0.00055539, -0.00029301, -0.02025189],
    "camera_pose": {
      "x": 0.0,
      "y": 0.0,
      "z": 0.5,
      "roll": 0.0,
      "pitch": 0.0,
      "yaw": 0.0
    },
    "tag_layout": [
      {
        "ID": 1,
        "pose": {"x": 0.0, "y": 0.0, "z": 0.0, "roll": 0.0, "pitch": 0.0, "yaw": 0.0}
      }
    ]
  }
}
```

### 2. 参数说明
- **tag_size**: 标签物理大小（米）
- **camera_matrix**: 相机内参矩阵
- **distortion_coeffs**: 相机畸变系数
- **camera_pose**: 相机相对于机器人的位置
- **tag_layout**: 场地中标签的绝对位置

## 使用步骤

### 1. 启动服务器
```bash
cd Singularity-vision
pip install -r requirements.txt
python camera_server.py
```

### 2. 访问界面
打开浏览器访问 `http://localhost:5001`

### 3. 查看坐标显示
- **顶部统计**：快速查看机器人 X、Y 坐标
- **机器人姿态**：查看详细的多标签姿态估计
- **标签详情**：查看各个标签的详细信息
- **视频流**：实时查看标注后的视频

### 4. API 调用
```python
import requests

# 获取姿态估计结果
response = requests.get('http://localhost:5001/api/apriltag_poses')
poses = response.json()

# 获取机器人位置
if poses['multi_tag_pose']:
    robot_pose = poses['multi_tag_pose']['field_to_robot_pose']
    print(f"机器人位置: ({robot_pose['x']:.3f}, {robot_pose['y']:.3f})")

# 获取配置信息
config_response = requests.get('http://localhost:5001/api/apriltag_config')
config = config_response.json()
print(f"标签大小: {config['tag_size']} 米")
```

## 坐标系说明

### 1. 相机坐标系
- **原点**：相机镜头中心
- **Z 轴**：相机光轴方向
- **单位**：米

### 2. 机器人坐标系
- **原点**：机器人中心
- **X 轴**：机器人前进方向
- **单位**：米

### 3. 场地坐标系
- **原点**：场地固定参考点
- **坐标**：绝对场地坐标
- **单位**：米

## 测试工具

### 运行测试客户端
```bash
python test_apriltag_api.py
```

测试客户端会：
- 验证 AprilTag 配置
- 测试姿态估计 API
- 显示检测结果
- 提供实时监控功能

## 故障排除

### 1. 坐标显示为 "N/A"
- 检查相机是否正常工作
- 确认 AprilTag 在视野内
- 验证标签 ID 是否在配置中

### 2. 多标签姿态不可用
- 需要同时检测到多个标签
- 确保标签位置配置正确
- 检查相机标定参数

### 3. 坐标精度问题
- 重新标定相机参数
- 检查标签平整度
- 调整相机位置配置

## 高级功能

### 1. 自定义标签布局
可以在配置文件中添加更多标签：
```json
{
  "ID": 5,
  "pose": {"x": 2.0, "y": 1.0, "z": 0.0, "roll": 0.0, "pitch": 0.0, "yaw": 1.57}
}
```

### 2. 动态配置
支持运行时修改配置参数（需要重启服务）

### 3. 数据记录
可以通过 API 记录姿态估计数据用于分析

---

## 技术支持

如有问题请查看：
- 服务器日志输出
- 浏览器控制台错误
- API 响应状态

基于 BlackholeVision2 架构，适配 Singularity-vision 系统。 